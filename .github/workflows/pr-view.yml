name: ü§ñ AI PR Reviewer (Ultra-Optimized)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Checkout repo
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1


    # ---------------------------------------------------------
    # 2Ô∏è‚É£ RESTORE HEAVY ML ENV (Torch + Transformers)
    # ---------------------------------------------------------
    - name: Restore ML venv cache
      id: cache-ml
      uses: actions/cache@v3
      with:
        path: .venv_ml
        key: venv-ml-${{ runner.os }}-static
        restore-keys: |
          venv-ml-${{ runner.os }}-static


    # 3Ô∏è‚É£ Create ML venv if not restored
    - name: Create ML venv (if missing)
      run: |
        if [ ! -d ".venv_ml" ]; then
          echo "Creating ML venv..."
          python3 -m venv .venv_ml
          source .venv_ml/bin/activate
          echo "Installing heavy ML packages..."
          pip install torch torchvision torchaudio --quiet --index-url https://download.pytorch.org/whl/cu121
          pip install transformers sentence-transformers --quiet
        else
          echo "ML venv restored from cache."
        fi


    # 4Ô∏è‚É£ Save ML venv (first PR only)
    - name: Save ML cache
      if: steps.cache-ml.outputs.cache-hit != 'true'
      uses: actions/cache/save@v3
      with:
        path: .venv_ml
        key: venv-ml-${{ runner.os }}-static


    # ---------------------------------------------------------
    # 5Ô∏è‚É£ RESTORE NORMAL venv (Fast deps)
    # ---------------------------------------------------------
    - name: Restore lightweight venv cache
      id: cache-light
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-light-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          venv-light-${{ runner.os }}-


    # 6Ô∏è‚É£ Create normal venv if missing
    - name: Create normal venv
      run: |
        if [ ! -d ".venv" ]; then
          echo "Creating normal venv..."
          python3 -m venv .venv
        fi


    # 7Ô∏è‚É£ Install only lightweight dependencies
    - name: Install lightweight deps
      run: |
        source .venv/bin/activate
        echo "Installing dependencies..."
        pip install -r requirements.txt --quiet
        pip install semgrep --quiet


    # 8Ô∏è‚É£ Save lightweight cache
    - name: Save lightweight venv cache
      if: steps.cache-light.outputs.cache-hit != 'true'
      uses: actions/cache/save@v3
      with:
        path: .venv
        key: venv-light-${{ runner.os }}-${{ hashFiles('requirements.txt') }}


    # ---------------------------------------------------------
    # 9Ô∏è‚É£ Warm up RAG Retriever
    # ---------------------------------------------------------
    - name: Warm up RAG retriever
      env:
        OWNER: kaushal0123
        REPO: Recipe-Management-System
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
        PINECONE_INDEX_NAME: ai
      run: |
        source .venv/bin/activate
        python -c "from rag_core import get_retriever; get_retriever()"


    # üîü Run your AI PR Reviewer
    - name: Run AI Reviewer
      env:
        OWNER: kaushal0123
        REPO: Recipe-Management-System
        PR_NUMBER: ${{ github.event.pull_request.number }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
        PINECONE_INDEX_NAME: ai
      run: |
        # Activate both venvs (normal + ML)
        source .venv/bin/activate
        source .venv_ml/bin/activate

        python main.py
