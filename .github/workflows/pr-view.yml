name: ü§ñ AI PR Reviewer (Ultra-Optimized CPU Torch)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    runs-on: ubuntu-latest
    timeout-minutes: 6

    steps:
    # 1Ô∏è‚É£ Checkout repo
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1


    # ---------------------------------------------------------
    # 2Ô∏è‚É£ RESTORE HEAVY ML ENV (Torch + Transformers)
    # ---------------------------------------------------------
    - name: Restore ML venv cache
      id: ml-cache
      uses: actions/cache@v3
      with:
        path: .venv_ml
        key: venv-ml-${{ runner.os }}-static
        restore-keys: |
          venv-ml-${{ runner.os }}-static


    # 3Ô∏è‚É£ Create ML venv if missing (install CPU Torch)
    - name: Create ML venv (if missing)
      run: |
        if [ ! -d ".venv_ml" ]; then
          echo "ML venv not found. Creating it now..."
          python3 -m venv .venv_ml
          source .venv_ml/bin/activate

          echo "Installing CPU version of PyTorch (small)..."
          pip install --quiet \
            torch==2.3.0+cpu \
            torchvision==0.18.0+cpu \
            torchaudio==2.3.0+cpu \
            -f https://download.pytorch.org/whl/torch_stable.html

          echo "Installing Transformers + Sentence Transformers..."
          pip install --quiet transformers sentence-transformers
        else
          echo "ML venv restored from cache."
        fi


    # 4Ô∏è‚É£ Save ML venv cache (only when first created)
    - name: Save ML venv cache
      if: steps.ml-cache.outputs.cache-hit != 'true'
      uses: actions/cache/save@v3
      with:
        path: .venv_ml
        key: venv-ml-${{ runner.os }}-static


    # ---------------------------------------------------------
    # 5Ô∏è‚É£ RESTORE NORMAL venv (light deps)
    # ---------------------------------------------------------
    - name: Restore lightweight venv cache
      id: light-cache
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-light-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          venv-light-${{ runner.os }}-


    # 6Ô∏è‚É£ Create normal venv if missing
    - name: Create normal venv
      run: |
        if [ ! -d ".venv" ]; then
          echo "Creating normal venv..."
          python3 -m venv .venv
        fi


    # 7Ô∏è‚É£ Install only lightweight dependencies
    - name: Install lightweight deps
      run: |
        source .venv/bin/activate
        echo "Installing dependencies..."
        pip install -r requirements.txt --quiet
        pip install semgrep --quiet


    # 8Ô∏è‚É£ Save lightweight venv cache
    - name: Save lightweight venv cache
      if: steps.light-cache.outputs.cache-hit != 'true'
      uses: actions/cache/save@v3
      with:
        path: .venv
        key: venv-light-${{ runner.os }}-${{ hashFiles('requirements.txt') }}


    # ---------------------------------------------------------
    # 9Ô∏è‚É£ Warm up RAG Retriever
    # ---------------------------------------------------------
    - name: Warm up RAG retriever
      env:
        OWNER: kaushal0123
        REPO: Recipe-Management-System
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
        PINECONE_INDEX_NAME: ai
      run: |
        source .venv/bin/activate
        python -c "from rag_core import get_retriever; get_retriever()"


    # üîü Run AI Reviewer
    - name: Run AI Reviewer
      env:
        OWNER: kaushal0123
        REPO: Recipe-Management-System
        PR_NUMBER: ${{ github.event.pull_request.number }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        PINECONE_API_KEY: ${{ secrets.PINECONE_API_KEY }}
        PINECONE_INDEX_NAME: ai
      run: |
        source .venv/bin/activate
        source .venv_ml/bin/activate
        python main.py
